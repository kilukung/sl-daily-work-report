<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SL Daily Work Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f0f4ff; }
    .table-container { overflow-x: auto; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(59,130,246,0.1),0 8px 10px -5px rgba(59,130,246,0.05);}
    .selected-row { background-color: #e0f2fe !important;}
    .holiday-cell { background-color: #fef2f2; color: #ef4444; font-weight: 500;}
    .today-cell { background-color: #f5f3ff; }
    .save-indicator { transition: opacity 0.3s ease-in-out;}
    .today-header { background: linear-gradient(135deg,#c7d2fe,#a5b4fc)!important; color:#4338ca!important; }
    .today-header .date-header { color:#4338ca; font-weight:600;}
    .btn { border-radius: 12px; font-weight: 500; transition: all 0.2s;}
    .btn:hover { transform: translateY(-1px);}
    .btn-primary { background: linear-gradient(135deg,#4f46e5,#6366f1); color:white;}
    .btn-export { background: linear-gradient(135deg,#f97316,#fb923c); color:white;}
    .btn-success { background: linear-gradient(135deg,#10b981,#34d399); color:white;}
    .app-header { background: linear-gradient(135deg,#4f46e5,#6366f1); color:white;}
    .app-title { background: linear-gradient(135deg,#ffffff,#e0e7ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
    .nav-button { border-radius:12px; transition:all 0.2s;}
    .nav-button.active { background:rgba(255,255,255,0.2);}
    .nav-button:hover:not(.active) { background:rgba(255,255,255,0.1);}
    .export-preview { position:fixed; top:0; left:0; right:0; bottom:0; background-color:rgba(0,0,0,0.75); display:flex; align-items:center; justify-content:center; z-index:100; padding:2rem;}
    .export-container { background-color:white; border-radius:16px; max-width:90%; max-height:90%; overflow:auto; position:relative;}
    .export-close { position:absolute; top:1rem; right:1rem; background-color:#ef4444; color:white; width:2rem; height:2rem; border-radius:9999px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold;}
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 flex flex-col items-center justify-center z-50">
    <div class="w-12 h-12 border-4 border-gray-200 border-t-indigo-500 rounded-full animate-spin"></div>
    <p class="mt-4 text-gray-700 font-medium">Loading schedule...</p>
  </div>

  <div class="min-h-screen flex flex-col">
    <header class="app-header shadow-md">
      <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold app-title">SL Daily Work Report</h1>
      </div>
      <div class="max-w-7xl mx-auto px-4 py-2 flex">
        <nav class="flex space-x-4">
          <button id="nav-schedule" class="px-4 py-2 text-sm font-medium nav-button active">Schedule</button>
          <button id="nav-settings" class="px-4 py-2 text-sm font-medium nav-button">Settings</button>
        </nav>
      </div>
    </header>

    <main class="flex-grow max-w-7xl w-full mx-auto px-4 py-8">
      <!-- Schedule View -->
      <div id="schedule-view" class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex justify-between mb-6">
          <h2 class="text-xl font-semibold">Weekly Schedule</h2>
          <div class="flex items-center space-x-3">
            <span id="save-indicator" class="text-sm text-green-600 opacity-0 save-indicator">Saved!</span>
            <button id="export-button" class="px-4 py-2 text-sm btn btn-export">Export</button>
            <button id="save-button" class="px-4 py-2 text-sm btn btn-primary" disabled>Save Changes</button>
          </div>
        </div>

        <div class="flex justify-between mb-6">
          <div>
            <button id="prev-week" class="px-2">◀</button>
            <span id="week-display" class="font-semibold text-indigo-600"></span>
            <button id="next-week" class="px-2">▶</button>
          </div>
          <div>
            <input type="date" id="date-picker" class="border rounded-xl p-1"/>
            <button id="today-button" class="ml-2 btn btn-primary px-3 py-1">Today</button>
          </div>
        </div>

        <div class="table-container">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2">Employee (Click to select)</th>
                <th class="px-4 py-2" id="monday-header">Monday <span class="date-header"></span></th>
                <th class="px-4 py-2" id="tuesday-header">Tuesday <span class="date-header"></span></th>
                <th class="px-4 py-2" id="wednesday-header">Wednesday <span class="date-header"></span></th>
                <th class="px-4 py-2" id="thursday-header">Thursday <span class="date-header"></span></th>
                <th class="px-4 py-2" id="friday-header">Friday <span class="date-header"></span></th>
              </tr>
            </thead>
            <tbody id="schedule-table-body" class="bg-white divide-y"></tbody>
          </table>
        </div>
      </div>

      <!-- Settings View -->
      <div id="settings-view" class="bg-white rounded-2xl shadow-lg p-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Settings - Holidays</h2>
        <div id="holidays-container" class="space-y-2"></div>
        <button id="add-holiday-button" class="mt-4 btn px-4 py-2 border">Add Holiday</button>
        <button id="settings-save-button" class="mt-4 ml-2 btn btn-primary px-4 py-2">Save Settings</button>
        <span id="settings-save-indicator" class="ml-3 text-green-600 opacity-0 save-indicator">Saved!</span>
      </div>
    </main>
  </div>

  <!-- Export Preview -->
  <div id="export-preview" class="export-preview hidden">
    <div class="export-container p-6">
      <div id="export-content"></div>
      <div class="export-close" id="export-close">✕</div>
      <div class="p-4 flex justify-center gap-4">
        <button id="download-image" class="btn btn-primary px-4 py-2">Download</button>
        <button id="copy-image" class="btn btn-success px-4 py-2">Copy</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAt7Fia37IluL7EC3I8-dHLZozhrCH3n8E",
      authDomain: "sl-daily-work-report.firebaseapp.com",
      projectId: "sl-daily-work-report",
      storageBucket: "sl-daily-work-report.firebasestorage.app",
      messagingSenderId: "728057348052",
      appId: "1:728057348052:web:b67f4b9d813cc8fbe72041",
      measurementId: "G-KPNES7BES6"
    };
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    const employees = ["P'Nuth","P'Note","P'Poom","P'O","Tew","PView","P'Bas","Big","Aim","Gib","Nut"];
    const daysOfWeek = ["Monday","Tuesday","Wednesday","Thursday","Friday"];
    const defaultLocations = ["Enco","BPO","Amata","Rst","Training","Office","WFH","Leave"];
    let selectedEmployee=null, hasChanges=false, currentData={}, holidays=[], currentWeekDates=[], currentWeekStart=null;
    const today=new Date();

    const loadingOverlay=document.getElementById("loading-overlay");
    const tableBody=document.getElementById("schedule-table-body");
    const saveButton=document.getElementById("save-button");
    const saveIndicator=document.getElementById("save-indicator");
    const weekDisplay=document.getElementById("week-display");
    const datePicker=document.getElementById("date-picker");

    function formatDate(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});}
    function formatDateForStorage(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
    function isSameDay(d1,d2){return d1.getFullYear()===d2.getFullYear()&&d1.getMonth()===d2.getMonth()&&d1.getDate()===d2.getDate();}
    function getMonday(d){const date=new Date(d);const day=date.getDay();const diff=date.getDate()-day+(day===0?-6:1);return new Date(date.setDate(diff));}
    function getWeekDisplayText(ws){const we=new Date(ws);we.setDate(we.getDate()+4);return `${ws.toLocaleDateString('en-US',{month:'long'})} ${ws.getDate()}-${we.getDate()}, ${ws.getFullYear()}`;}
    function isHoliday(d){return holidays.some(h=>h.date===formatDateForStorage(d));}
    function getHolidayName(d){const f=formatDateForStorage(d);const h=holidays.find(x=>x.date===f);return h?h.name:'';}

    function createCombobox(container,initialValue,options,onChange){
      const select=document.createElement("select");
      const optEmpty=document.createElement("option");optEmpty.value="";optEmpty.textContent="";select.appendChild(optEmpty);
      options.forEach(op=>{const o=document.createElement("option");o.textContent=op;select.appendChild(o);});
      select.value=initialValue||"";
      select.className="border rounded px-2 py-1";
      select.addEventListener("change",()=>onChange(select.value));
      container.appendChild(select);
    }

    function initializeTable(){
      tableBody.innerHTML="";
      employees.forEach(emp=>{
        const tr=document.createElement("tr");
        tr.className=emp===selectedEmployee?"selected-row":"";
        tr.addEventListener("click",()=>{selectedEmployee=emp;initializeTable();});
        const td=document.createElement("td");td.className="px-4 py-2";td.textContent=emp;tr.appendChild(td);
        daysOfWeek.forEach((day,i)=>{
          const d=currentWeekDates[i];const fd=formatDateForStorage(d);
          const cell=document.createElement("td");cell.className="px-4 py-2";
          if(isHoliday(d)){cell.textContent="Holiday: "+getHolidayName(d);cell.className+=" holiday-cell";}
          else{
            const val=currentData[emp]?.[fd]||"";
            if(emp===selectedEmployee) createCombobox(cell,val,defaultLocations,(nv)=>{if(!currentData[emp])currentData[emp]={};currentData[emp][fd]=nv;hasChanges=true;saveButton.disabled=false;});
            else cell.textContent=val;
          }
          if(isSameDay(d,today)) cell.className+=" today-cell";
          tr.appendChild(cell);
        });
        tableBody.appendChild(tr);
      });
    }

    function setCurrentWeek(ws){
      currentWeekStart=ws;currentWeekDates=[];
      weekDisplay.textContent=getWeekDisplayText(ws);
      datePicker.value=formatDateForStorage(ws);
      for(let i=0;i<5;i++){const d=new Date(ws);d.setDate(d.getDate()+i);currentWeekDates.push(d);}
      ["monday","tuesday","wednesday","thursday","friday"].forEach((id,i)=>{
        const h=document.getElementById(id+"-header");const span=h.querySelector(".date-header");
        span.textContent=formatDate(currentWeekDates[i]);
        h.classList.remove("today-header");
        if(isSameDay(currentWeekDates[i],today)) h.classList.add("today-header");
      });
      initializeTable();
    }

    async function fetchData(){
      const sSnap=await getDocs(collection(db,"schedules"));
      sSnap.forEach(d=>{currentData[d.id]=d.data();});
      const hSnap=await getDoc(doc(db,"settings","holidays"));
      if(hSnap.exists()) holidays=hSnap.data().holidays||[];
      setCurrentWeek(getMonday(today));
      loadingOverlay.style.display="none";
      renderHolidays();
    }

    document.getElementById("save-button").addEventListener("click",async()=>{
      if(!selectedEmployee||!hasChanges)return;
      saveButton.disabled=true;saveButton.textContent="Saving...";
      await setDoc(doc(db,"schedules",selectedEmployee),currentData[selectedEmployee]||{},{merge:true});
      saveIndicator.style.opacity=1;setTimeout(()=>saveIndicator.style.opacity=0,2000);
      hasChanges=false;saveButton.textContent="Save Changes";
    });

    document.getElementById("prev-week").addEventListener("click",()=>{const d=new Date(currentWeekStart);d.setDate(d.getDate()-7);setCurrentWeek(d);});
    document.getElementById("next-week").addEventListener("click",()=>{const d=new Date(currentWeekStart);d.setDate(d.getDate()+7);setCurrentWeek(d);});
    datePicker.addEventListener("change",()=>setCurrentWeek(getMonday(new Date(datePicker.value))));
    document.getElementById("today-button").addEventListener("click",()=>setCurrentWeek(getMonday(new Date())));

    // Holidays UI
    const holidaysContainer=document.getElementById("holidays-container");
    function renderHolidays(){
      holidaysContainer.innerHTML="";
      holidays.forEach((h,i)=>{
        const div=document.createElement("div");div.className="flex gap-2";
        const inpDate=document.createElement("input");inpDate.type="date";inpDate.value=h.date;inpDate.className="border rounded px-2";inpDate.onchange=()=>holidays[i].date=inpDate.value;
        const inpName=document.createElement("input");inpName.type="text";inpName.value=h.name;inpName.placeholder="Holiday name";inpName.className="border rounded px-2 flex-1";inpName.oninput=()=>holidays[i].name=inpName.value;
        const btn=document.createElement("button");btn.textContent="X";btn.className="px-2 border text-red-600";btn.onclick=()=>{holidays.splice(i,1);renderHolidays();};
        div.append(inpDate,inpName,btn);holidaysContainer.appendChild(div);
      });
    }
    document.getElementById("add-holiday-button").onclick=()=>{holidays.push({date:formatDateForStorage(today),name:""});renderHolidays();};
    document.getElementById("settings-save-button").onclick=async()=>{
      await setDoc(doc(db,"settings","holidays"),{holidays});
      document.getElementById("settings-save-indicator").style.opacity=1;
      setTimeout(()=>document.getElementById("settings-save-indicator").style.opacity=0,2000);
      initializeTable();
    };

    // Switch views
    document.getElementById("nav-schedule").onclick=()=>{document.getElementById("schedule-view").classList.remove("hidden");document.getElementById("settings-view").classList.add("hidden");document.getElementById("nav-schedule").classList.add("active");document.getElementById("nav-settings").classList.remove("active");};
    document.getElementById("nav-settings").onclick=()=>{document.getElementById("schedule-view").classList.add("hidden");document.getElementById("settings-view").classList.remove("hidden");document.getElementById("nav-settings").classList.add("active");document.getElementById("nav-schedule").classList.remove("active");};

    fetchData();
  </script>
</body>
</html>
