<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SL Daily Work Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        kanit: ['Kanit', 'sans-serif'],
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: { DEFAULT: '#4F46E5', hover: '#4338CA' },
                        accent: { DEFAULT: '#F97316', hover: '#EA580C' },
                        success: { DEFAULT: '#10B981', hover: '#059669' },
                        danger: { DEFAULT: '#EF4444', hover: '#DC2626' },
                        'base-100': '#FFFFFF',
                        'base-200': '#F8FAFC',
                        'base-300': '#F1F5F9',
                        'border-color': '#E5E7EB',
                        'text-primary': '#1E293B',
                        'text-secondary': '#64748B',
                    },
                    boxShadow: {
                        soft: '0 4px 12px rgba(0, 0, 0, 0.05)',
                        'soft-lg': '0 10px 25px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F1F5F9;
            color: #1E293B;
        }
        h1, h2, h3, h4, h5, h6, .font-kanit {
            font-family: 'Kanit', sans-serif;
        }
        .main-card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn { @apply px-4 py-2 rounded-lg font-semibold text-sm shadow-soft transition-all duration-200 ease-in-out transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-primary { @apply bg-primary text-white hover:bg-primary-hover; }
        .btn-accent { @apply bg-accent text-white hover:bg-accent-hover; }
        .btn-secondary { @apply bg-base-300 text-text-primary hover:bg-border-color; }
        .btn-danger-outline { @apply bg-white border border-danger text-danger hover:bg-danger/10; }

        .input-field { @apply w-full border border-border-color rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50; }
        
        .selected-row { background-color: #EBF5FF !important; }
        .holiday-cell { background-color: #FFF1F2; color: #EF4444; font-weight: 500; }
        .today-cell { position: relative; }
        .today-cell::before { content: ''; position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; border-radius: 9999px; background-color: #4F46E5;}
        
        /* Export Preview Modal */
        .export-preview {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.75); display: flex; align-items: center; justify-content: center;
            z-index: 100; padding: 2rem; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .export-preview.visible { opacity: 1; pointer-events: auto; }
        .export-container {
            background: white; border-radius: 16px; max-width: 95%; max-height: 95%; overflow: auto;
            position: relative; transform: scale(0.95); transition: transform 0.3s ease;
        }
        .export-preview.visible .export-container { transform: scale(1); }
        .export-close {
            position: absolute; top: 1rem; right: 1rem;
            background: #ef4444; color: white; width: 2rem; height: 2rem; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; z-index: 10;
        }
    </style>
</head>
<body class="antialiased">
    <div id="export-render-area" class="fixed -left-[9999px] top-0 p-8 bg-slate-100"></div>
    
    <div class="min-h-screen flex flex-col">
        <header class="bg-primary text-white px-4 sm:px-6 py-4 shadow-lg">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <h1 class="text-2xl font-bold tracking-tight">SL Daily Work Report</h1>
                <nav class="space-x-2 sm:space-x-4">
                    <button id="nav-schedule" class="px-3 py-2 text-sm sm:text-base sm:px-4 bg-white/10 rounded-lg font-medium hover:bg-white/20 ring-2 ring-white/50">Schedule</button>
                    <button id="nav-settings" class="px-3 py-2 text-sm sm:text-base sm:px-4 bg-transparent rounded-lg font-medium hover:bg-white/20">Settings</button>
                </nav>
            </div>
        </header>

        <main class="flex-grow max-w-7xl w-full mx-auto px-4 py-8">
            <div id="schedule-view" class="main-card shadow-soft-lg p-4 sm:p-6 rounded-2xl">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-primary font-kanit">Weekly Schedule</h2>
                    <div class="flex items-center gap-3">
                        <span id="save-indicator" class="text-sm text-success opacity-0 transition-opacity duration-300">✓ Changes saved!</span>
                        <button id="export-button" class="btn btn-accent">Export</button>
                        <button id="save-button" class="btn btn-primary" disabled>Save</button>
                    </div>
                </div>

                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <button id="prev-week" class="w-9 h-9 flex items-center justify-center rounded-full bg-base-300 hover:bg-border-color transition">◀</button>
                        <span id="week-display" class="text-sm sm:text-base font-medium text-primary text-center"></span>
                        <button id="next-week" class="w-9 h-9 flex items-center justify-center rounded-full bg-base-300 hover:bg-border-color transition">▶</button>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="date" id="date-picker" class="input-field max-w-[150px]" />
                        <button id="today-button" class="btn btn-primary">Today</button>
                    </div>
                </div>

                <div class="table-container bg-white rounded-xl shadow-soft overflow-x-auto">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-base-200 text-text-secondary">
                            <tr>
                                <th class="p-3 font-semibold">Employee</th>
                                <th class="p-3 font-semibold min-w-[150px]">Mon</th>
                                <th class="p-3 font-semibold min-w-[150px]">Tue</th>
                                <th class="p-3 font-semibold min-w-[150px]">Wed</th>
                                <th class="p-3 font-semibold min-w-[150px]">Thu</th>
                                <th class="p-3 font-semibold min-w-[150px]">Fri</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-table-body" class="divide-y divide-border-color">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="settings-view" class="hidden mt-6 main-card p-4 sm:p-6 rounded-2xl shadow-soft-lg">
                <h2 class="text-xl font-semibold mb-4 text-primary font-kanit">Settings - Holidays</h2>
                <div id="holidays-container" class="space-y-3"></div>
                <div class="mt-4 flex flex-wrap gap-2">
                    <button id="add-holiday-button" class="btn btn-secondary">Add Holiday</button>
                    <button id="settings-save-button" class="btn btn-primary">Save Settings</button>
                    <span id="settings-save-indicator" class="text-success text-sm opacity-0 flex items-center">✓ Saved!</span>
                </div>
            </div>
        </main>
    </div>

    <div id="export-preview" class="export-preview">
        <div class="export-container">
            <div class="p-6"><div id="export-content"></div></div>
            <div class="export-close" id="export-close">✕</div>
            <div class="p-4 bg-base-200 flex justify-center gap-4 border-t">
                <button id="download-image" class="btn btn-primary">Download</button>
                <button id="copy-image" class="btn bg-success text-white hover:bg-success-hover">Copy to Clipboard</button>
            </div>
        </div>
    </div>
    
    <datalist id="locations-list"></datalist>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, doc, getDoc, getDocs, setDoc, collection } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAt7Fia37IluL7EC3I8-dHLZozhrCH3n8E", // ¡Considera usar reglas de seguridad de Firestore!
    authDomain: "sl-daily-work-report.firebaseapp.com",
    projectId: "sl-daily-work-report",
    storageBucket: "sl-daily-work-report.appspot.com",
    messagingSenderId: "728057348052",
    appId: "1:728057348052:web:b67f4b9d813cc8fbe72041",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// === Data ===
const employees = ["P'Nuth", "P'Note", "P'Poom", "P'O", "Tew", "PView", "P'Bas", "Big", "Aim", "Gib", "Nut"];
const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
const defaultLocations = ["Enco", "BPO", "Amata", "Rst", "Training", "Office", "WFH", "Leave"];

let selectedEmployee = null, hasChanges = false, currentData = {}, holidays = [], currentWeekDates = [], currentWeekStart = null;
const today = new Date();

// === DOM Elements ===
const tableBody = document.getElementById("schedule-table-body");
const saveButton = document.getElementById("save-button");
const saveIndicator = document.getElementById("save-indicator");
const weekDisplay = document.getElementById("week-display");
const datePicker = document.getElementById("date-picker");
const locationsDatalist = document.getElementById("locations-list");

// === Helper Functions ===
function formatDateForStorage(d) { return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
function isSameDay(d1, d2) { return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }
function getMonday(d) { const date = new Date(d); const day = date.getDay(); const diff = date.getDate() - day + (day === 0 ? -6 : 1); return new Date(date.setDate(diff)); }
function getWeekDisplayText(ws) { const we = new Date(ws); we.setDate(we.getDate() + 4); return `${ws.toLocaleDateString('en-US', { month: 'long' })} ${ws.getDate()} - ${we.getDate()}, ${ws.getFullYear()}`; }
function isHoliday(d) { return holidays.some(h => h.date === formatDateForStorage(d)); }
function getHolidayName(d) { const h = holidays.find(x => x.date === formatDateForStorage(d)); return h ? h.name : ''; }

// *** IMPROVED: Creates an input with a datalist for suggestions and custom entry ***
function createEditableInput(container, initialValue, onChange) {
    const input = document.createElement("input");
    input.type = "text";
    input.className = "input-field";
    input.value = initialValue || "";
    input.setAttribute("list", "locations-list");
    input.addEventListener("input", () => onChange(input.value));
    container.appendChild(input);
}

function initializeTable() {
    tableBody.innerHTML = "";
    employees.forEach(emp => {
        const tr = document.createElement("tr");
        tr.className = `cursor-pointer hover:bg-base-300/50 ${emp === selectedEmployee ? "selected-row" : ""}`;
        tr.addEventListener("click", () => {
            selectedEmployee = emp;
            initializeTable(); // Re-render to show inputs for the selected employee
        });

        const tdName = document.createElement("td");
        tdName.className = "p-3 font-medium text-text-primary";
        tdName.textContent = emp;
        tr.appendChild(tdName);

        daysOfWeek.forEach((day, i) => {
            const d = currentWeekDates[i];
            const formattedDate = formatDateForStorage(d);
            const cell = document.createElement("td");
            cell.className = "p-2"; // Use p-2 for cells with inputs

            if (isHoliday(d)) {
                cell.className += " holiday-cell text-center p-3";
                cell.textContent = `Holiday: ${getHolidayName(d)}`;
            } else {
                const value = currentData[emp]?.[formattedDate] || "";
                if (emp === selectedEmployee) {
                    createEditableInput(cell, value, (newValue) => {
                        if (!currentData[emp]) currentData[emp] = {};
                        currentData[emp][formattedDate] = newValue;
                        hasChanges = true;
                        saveButton.disabled = false;
                    });
                } else {
                    cell.className += " p-3";
                    cell.textContent = value;
                }
            }
            if (isSameDay(d, today)) cell.className += " today-cell";
            tr.appendChild(cell);
        });
        tableBody.appendChild(tr);
    });
}

function setCurrentWeek(weekStart) {
    currentWeekStart = weekStart;
    currentWeekDates = [];
    weekDisplay.textContent = getWeekDisplayText(weekStart);
    datePicker.value = formatDateForStorage(weekStart);
    for (let i = 0; i < 5; i++) {
        const d = new Date(weekStart);
        d.setDate(d.getDate() + i);
        currentWeekDates.push(d);
    }
    initializeTable();
}

async function fetchData() {
    // Fetch schedules
    const schedulesSnapshot = await getDocs(collection(db, "schedules"));
    schedulesSnapshot.forEach(doc => {
        currentData[doc.id] = doc.data();
    });

    // Fetch holidays
    const holidaysSnapshot = await getDoc(doc(db, "settings", "holidays"));
    if (holidaysSnapshot.exists()) {
        holidays = holidaysSnapshot.data().holidays || [];
    }
    
    // Populate datalist
    locationsDatalist.innerHTML = '';
    defaultLocations.forEach(loc => {
        const option = document.createElement('option');
        option.value = loc;
        locationsDatalist.appendChild(option);
    });

    setCurrentWeek(getMonday(today));
    renderHolidays();
}

// === Event Listeners ===

// Save Schedule
saveButton.addEventListener("click", async () => {
    if (!selectedEmployee || !hasChanges) return;
    saveButton.disabled = true;
    saveButton.textContent = "Saving...";
    await setDoc(doc(db, "schedules", selectedEmployee), currentData[selectedEmployee] || {}, { merge: true });
    
    saveIndicator.style.opacity = 1;
    setTimeout(() => { saveIndicator.style.opacity = 0; }, 2000);
    
    hasChanges = false;
    saveButton.textContent = "Save";
});

// Week Navigation
document.getElementById("prev-week").addEventListener("click", () => {
    const d = new Date(currentWeekStart); d.setDate(d.getDate() - 7); setCurrentWeek(d);
});
document.getElementById("next-week").addEventListener("click", () => {
    const d = new Date(currentWeekStart); d.setDate(d.getDate() + 7); setCurrentWeek(d);
});
datePicker.addEventListener("change", () => setCurrentWeek(getMonday(new Date(datePicker.value))));
document.getElementById("today-button").addEventListener("click", () => setCurrentWeek(getMonday(new Date())));

// Settings & Holidays
const holidaysContainer = document.getElementById("holidays-container");
function renderHolidays() {
    holidaysContainer.innerHTML = "";
    holidays.forEach((h, i) => {
        const div = document.createElement("div");
        div.className = "flex gap-2 items-center";
        
        const inpDate = document.createElement("input");
        inpDate.type = "date";
        inpDate.value = h.date;
        inpDate.className = "input-field";
        inpDate.onchange = () => holidays[i].date = inpDate.value;
        
        const inpName = document.createElement("input");
        inpName.type = "text";
        inpName.value = h.name;
        inpName.placeholder = "Holiday name";
        inpName.className = "input-field flex-1";
        inpName.oninput = () => holidays[i].name = inpName.value;
        
        const btn = document.createElement("button");
        btn.textContent = "✕";
        btn.className = "btn btn-danger-outline !px-3 !py-1";
        btn.onclick = () => { holidays.splice(i, 1); renderHolidays(); };
        
        div.append(inpDate, inpName, btn);
        holidaysContainer.appendChild(div);
    });
}
document.getElementById("add-holiday-button").onclick = () => {
    holidays.push({ date: formatDateForStorage(today), name: "" });
    renderHolidays();
};
document.getElementById("settings-save-button").onclick = async () => {
    await setDoc(doc(db, "settings", "holidays"), { holidays });
    const indicator = document.getElementById("settings-save-indicator");
    indicator.style.opacity = 1;
    setTimeout(() => { indicator.style.opacity = 0; }, 2000);
    initializeTable(); // Refresh table to reflect new holidays
};

// View Switching
const navButtons = { schedule: document.getElementById("nav-schedule"), settings: document.getElementById("nav-settings") };
const views = { schedule: document.getElementById("schedule-view"), settings: document.getElementById("settings-view") };
function switchView(viewName) {
    Object.keys(views).forEach(key => {
        views[key].classList.toggle("hidden", key !== viewName);
        navButtons[key].classList.toggle("ring-2", key === viewName);
        navButtons[key].classList.toggle("ring-white/50", key === viewName);
        navButtons[key].classList.toggle("bg-white/10", key === viewName);
        navButtons[key].classList.toggle("bg-transparent", key !== viewName);
    });
}
navButtons.schedule.onclick = () => switchView("schedule");
navButtons.settings.onclick = () => switchView("settings");

// *** IMPROVED: Export Functionality ***
function generateExportHtml() {
    const headerHtml = daysOfWeek.map((day, i) => `<th class="p-3 font-semibold text-left">${day.slice(0,3)}<br><span class="font-normal text-text-secondary">${currentWeekDates[i].getDate()}</span></th>`).join('');

    const bodyHtml = employees.map(emp => {
        const cellsHtml = currentWeekDates.map(d => {
            const formattedDate = formatDateForStorage(d);
            let cellContent = '';
            let cellClass = 'p-3 text-center';
            if (isHoliday(d)) {
                cellClass += ' bg-red-50 text-red-600';
                cellContent = `Holiday`;
            } else {
                cellContent = currentData[emp]?.[formattedDate] || '-';
            }
            if(isSameDay(d, today)) cellClass += ' border-2 border-primary';
            return `<td class="${cellClass}">${cellContent}</td>`;
        }).join('');
        return `<tr><td class="p-3 font-semibold text-text-primary">${emp}</td>${cellsHtml}</tr>`;
    }).join('');

    return `
        <div class="w-[800px] bg-white p-6 rounded-2xl shadow-lg font-inter">
            <h1 class="text-2xl font-bold text-primary font-kanit">SL Work Schedule</h1>
            <p class="text-lg text-text-secondary mb-4">${getWeekDisplayText(currentWeekStart)}</p>
            <table class="w-full text-sm border-collapse">
                <thead class="bg-base-200 text-text-secondary">
                    <tr><th class="p-3 font-semibold text-left">Employee</th>${headerHtml}</tr>
                </thead>
                <tbody class="divide-y divide-border-color">${bodyHtml}</tbody>
            </table>
        </div>
    `;
}

document.getElementById("export-button").addEventListener("click", async () => {
    const renderArea = document.getElementById("export-render-area");
    renderArea.innerHTML = generateExportHtml();
    
    const exportElement = renderArea.firstElementChild;
    const canvas = await html2canvas(exportElement, { scale: 2, backgroundColor: null });
    
    const img = document.createElement("img");
    img.src = canvas.toDataURL("image/png");
    img.id = "export-image";
    img.style.width = '100%';
    img.style.borderRadius = '8px';

    const exportContent = document.getElementById("export-content");
    exportContent.innerHTML = "";
    exportContent.appendChild(img);
    document.getElementById("export-preview").classList.add("visible");
});
document.getElementById("export-close").addEventListener("click", () => document.getElementById("export-preview").classList.remove("visible"));

document.getElementById("download-image").addEventListener("click", () => {
    const img = document.getElementById("export-image"); if (!img) return;
    const link = document.createElement("a");
    link.download = `SL_Schedule_${formatDateForStorage(currentWeekStart)}.png`;
    link.href = img.src;
    link.click();
});

document.getElementById("copy-image").addEventListener("click", async () => {
    try {
        const img = document.getElementById("export-image"); if (!img) return;
        const blob = await (await fetch(img.src)).blob();
        await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
        alert("Image copied to clipboard!");
    } catch (err) {
        console.error("Failed to copy image: ", err);
        alert("Could not copy image. Your browser might not support this feature.");
    }
});

// Initial Load
fetchData();
</script>
</body>
</html>